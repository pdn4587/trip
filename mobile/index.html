<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>여러 일정 관리 · 모바일 (Ably)</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#121821; --muted:#2a3443; --text:#e6edf3; --accent:#53b3ff; --accent2:#82e0aa; --danger:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif;-webkit-tap-highlight-color:transparent}
    a{color:var(--accent);text-decoration:none}
    button{font:inherit}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,15,20,.98),rgba(11,15,20,.85));backdrop-filter:blur(6px);z-index:10}
    .wrap{max-width:860px;margin:0 auto;padding:12px}
    .title{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
    .title h1{margin:0;font-size:20px;cursor:pointer}
    .badge{font-size:12px;padding:4px 8px;border:1px solid #2a3443;border-radius:999px;color:#b9c4d0;cursor:pointer}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .select{flex:1;min-width:160px;border:1px solid #334055;background:#0f1620;color:#d7e2ee;padding:8px;border-radius:10px}
    .btn{border:1px solid #344055;background:#141b26;color:#d7e2ee;border-radius:10px;padding:10px 12px;font-size:14px;cursor:pointer;touch-action:manipulation}
    .btn:hover{border-color:#3f5068}
    .btn.danger{border-color:#7a3940;background:#201114;color:#ffc9c9}
    .btn.ghost{background:transparent;border-color:#334055}
    .explain{margin:12px;background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:12px}
    .explain [data-editable]{outline:none;border-radius:10px;padding:8px;background:#0e131b;border:1px dashed #394456}
    .board{margin:12px;background:#151e2b;border:1px solid #3e5068;border-radius:16px;padding:12px}
    .board .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap}
    .slots{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px}
    @media (max-width:520px){ .slots{grid-template-columns:1fr;} }
    .card{position:relative;background:#0e151e;border:1px solid #394456;border-radius:12px;overflow:hidden}
    .card img{display:block;width:100%;height:120px;object-fit:cover}
    .card .body{padding:8px}
    .card .title{font-size:14px;font-weight:600}
    .noteToggle{margin-top:6px;width:100%;background:#192130;border:1px solid #2b374a;color:#c9d6e2;padding:6px;border-radius:8px;cursor:pointer}
    .note{margin-top:8px;display:none}
    .note textarea{width:100%;min-height:70px;background:#0b1118;color:#d9e4ef;border:1px solid #334055;border-radius:8px;padding:8px;resize:vertical}
    .toolbar-inline{display:flex;gap:6px;margin-top:8px}
    .mini{padding:6px 8px;border-radius:8px;font-size:12px}
    .gallery{margin:12px;background:#0c1118;border:1px solid #3a4558;border-radius:14px;padding:12px}
    .gallery h3{margin:0 0 8px 0}
    .gallery .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:520px){ .gallery .grid{grid-template-columns:1fr;} }
    .gcard{position:relative;background:#12131a;border:1px solid #3f4a5f;border-radius:12px;overflow:hidden}
    .gcard img{display:block;width:100%;height:120px;object-fit:cover}
    .gcard .cap{padding:8px;font-size:13px;color:#cbd6e3}
    .gtools{display:flex;gap:6px;padding:8px;flex-wrap:wrap}
    .gtools .btn.add{border-color:#39557a}
  </style>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1 id="hTitle">좌클릭하여 제목을 수정하세요.</h1>
        <span id="hBadge" class="badge">좌클릭하여 설명을 수정하세요.</span>
      </div>
      <div class="toolbar">
        <select id="planSelect" class="select" title="일정 선택"></select>
        <button class="btn" id="newPlanBtn" type="button">새 일정</button>
        <button class="btn" id="renamePlanBtn" type="button">이름 바꾸기</button>
        <button class="btn danger" id="deletePlanBtn" type="button">삭제</button>
      </div>
    </div>
  </header>

  <main>
    <section class="explain">
      <h2 style="margin:0 0 8px 0;font-size:18px">상단: 여행 설명</h2>
      <div id="intro" data-editable="true" contenteditable="true">여기에 여행의 목적, 분위기, 이동수단, 숙소 위치, 예산 등을 자유롭게 적어주세요.</div>
      <div class="hint">Tip: 내용을 수정하면 1초 뒤 자동 저장됩니다.</div>
    </section>

    <section class="board">
      <div class="bar">
        <strong>내 일정</strong>
        <div class="footer">
          <input id="roomId" placeholder="공유 코드(예: sapporo-trip)" style="padding:6px 8px;border-radius:8px;border:1px solid #334055;background:#0e151e;color:#e6edf3;min-width:160px" />
          <button class="btn" id="syncToggle">실시간 동기화: 꺼짐</button>
        </div>
      </div>
      <div id="schedule" class="slots" aria-label="일정 영역"></div>
    </section>

    <section class="gallery">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>관광지 갤러리</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="addPlaceBtn" type="button">관광지 추가</button>
        </div>
      </div>
      <div id="galleryGrid" class="grid"></div>
    </section>

    <div class="wrap" style="padding:12px 16px 24px;display:flex;justify-content:center">
      <a href="https://pdn4587.github.io/trip/?room=trip" class="btn ghost" style="text-align:center">PC 버전으로 보기</a>
    </div>
  </main>

  <script>
    const DEFAULT_GALLERY = [
      { id:"odori", title:"오도리 공원", img:"https://images.unsplash.com/photo-1511732351157-1865efcb7b7b?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"beer", title:"삿포로 맥주 박물관", img:"https://images.unsplash.com/photo-1545431781-c66d5fdbaf93?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"moiwa", title:"모이와 산 로프웨이", img:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"otaru", title:"오타루 운하", img:"https://images.unsplash.com/photo-1587563228632-4f7594dfdf0f?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"nijo", title:"니조 시장", img:"https://images.unsplash.com/photo-1488459716781-31db52582fe9?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"jozankei", title:"조잔케이 온천", img:"https://images.unsplash.com/photo-1501555088652-021faa106b9b?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"clock", title:"삿포로 시계탑", img:"https://images.unsplash.com/photo-1607603751895-d1715e4a7669?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"susukino", title:"스스키노", img:"https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?q=80&w=1200&auto=format&fit=crop", link:null }
    ];

    const APP_KEY='itinerary-app-v1';
    let app={ activeId:null, items:[] };
    const byId = id=>document.getElementById(id);
    const uid = ()=> Math.random().toString(36).slice(2,9);
    const cur = ()=> app.items.find(p=>p.id===app.activeId);

    function newPlanTemplate(name='새 일정'){ return { id:'plan-'+uid(), name, headerTitle:'좌클릭하여 제목을 수정하세요.', headerBadge:'좌클릭하여 설명을 수정하세요.', intro:'', schedule:[], gallery:[], roomId:'' }; }
    function saveApp(){ localStorage.setItem(APP_KEY, JSON.stringify(app)); }
    function loadApp(){ const raw=localStorage.getItem(APP_KEY); if(raw){ try{app=JSON.parse(raw);}catch{}} if(app.items.length===0){ const p=newPlanTemplate('첫 일정'); p.gallery=[...DEFAULT_GALLERY]; app.items.push(p); app.activeId=p.id; saveApp(); } if(!app.activeId) app.activeId=app.items[0].id; }

    function renderPlanSelect(){ const sel=byId('planSelect'); sel.innerHTML=app.items.map(p=>`<option value="${p.id}" ${p.id===app.activeId?'selected':''}>${p.name} (${p.schedule.length})</option>`).join(''); sel.onchange=()=>switchPlan(sel.value); }
    function switchPlan(id){ if(id===app.activeId) return; stopSync(); app.activeId=id; saveState(); applyState(); }
    function createPlan(){ const name=prompt('새 일정 이름','새 일정'); if(!name) return; const p=newPlanTemplate(name.trim()); p.gallery=[...DEFAULT_GALLERY]; app.items.push(p); app.activeId=p.id; saveState(); applyState(); }
    function renamePlan(){ const p=cur(); const name=prompt('일정 이름', p.name); if(name===null) return; p.name=name.trim()||p.name; saveState(); applyState(); }
    function deletePlan(){ if(app.items.length<=1){ alert('마지막 일정은 삭제할 수 없어요'); return; } const idx=app.items.findIndex(x=>x.id===app.activeId); app.items.splice(idx,1); app.activeId=app.items[0].id; saveState(); stopSync(); applyState(); }

    function bindHeaderEdit(){ const hTitle=byId('hTitle'), hBadge=byId('hBadge'); const edit=(el,key,msg)=> el.addEventListener('click', ()=>{ const c=cur(); const val=prompt(msg, c[key]||el.textContent); if(val===null) return; el.textContent=(val.trim()||el.textContent); c[key]=el.textContent; saveState(); }); edit(hTitle,'headerTitle','페이지 제목을 입력하세요'); edit(hBadge,'headerBadge','배지 캡션을 입력하세요'); }

    function renderGallery(){ const c=cur(); const list=c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]); const grid=byId('galleryGrid'); grid.innerHTML=''; list.forEach(item=>{ const card=document.createElement('div'); card.className='gcard'; card.innerHTML=`<img src="${item.img}" alt="${item.title}" draggable="false"><div class="cap">${item.title}</div><div class="gtools"><button class="btn" title="편집">편집</button><button class="btn danger" title="삭제">삭제</button></div>`; card.querySelector('[title="편집"]').addEventListener('click', ()=> editPlace(item.id)); card.querySelector('[title="삭제"]').addEventListener('click', ()=> removePlace(item.id)); card.addEventListener('dragstart', e=> e.preventDefault()); // 모바일 기본 방지
      const addBtn=document.createElement('button'); addBtn.className='btn add'; addBtn.textContent='일정에 추가'; addBtn.addEventListener('click', ()=>{ const inst={ uid:uid(), refId:item.id, title:item.title, img:item.img, note:'', link:item.link||null }; c.schedule.push(inst); saveState(); renderSchedule(); renderPlanSelect(); }); card.querySelector('.gtools').prepend(addBtn);
      document.getElementById('galleryGrid').appendChild(card);
    });}
    function addPlace(){ const c=cur(); const title=prompt('여행지 이름'); if(!title) return; const img=prompt('대표 이미지 URL'); if(!img) return; const link=prompt('기본 링크(URL, 선택)')||null; const id=title.toLowerCase().replace(/\s+/g,'-')+'-'+uid(); const item={id,title,img,link: link&&link.trim()? (/^(https?:)\/\//i.test(link)?link:'https://'+link.trim()): null }; const list=c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]); list.push(item); saveState(); renderGallery(); }
    function editPlace(id){ const c=cur(); const list=c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]); const g=list.find(x=>x.id===id); if(!g) return; const title=prompt('여행지 이름', g.title); if(title===null) return; const img=prompt('대표 이미지 URL', g.img); if(img===null) return; const link=prompt('기본 링크(URL, 비우면 없음)', g.link||''); if(link===null) return; g.title=title.trim()||g.title; g.img=img.trim()||g.img; g.link=link.trim()? (/^(https?:)\/\//i.test(link)?link:'https://'+link.trim()) : null; saveState(); renderGallery(); renderSchedule(); }
    function removePlace(id){ const c=cur(); const list=c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]); const idx=list.findIndex(x=>x.id===id); if(idx<0) return; list.splice(idx,1); saveState(); renderGallery(); }

    function renderSchedule(){ const c=cur(); const el=byId('schedule'); el.innerHTML=''; c.schedule.forEach((s,i)=> el.appendChild(makeSchedCard(s,i)) ); }
    function makeSchedCard(s,index){ const card=document.createElement('div'); card.className='card'; const img=document.createElement('img'); img.src=s.img; img.alt=s.title; img.draggable=false; img.addEventListener('click', ()=>{ if(s.link) window.open(s.link,'_blank'); }); const body=document.createElement('div'); body.className='body'; const t=document.createElement('div'); t.className='title'; t.textContent=s.title; body.appendChild(t); const noteBtn=document.createElement('button'); noteBtn.className='noteToggle btn mini'; noteBtn.textContent='메모 펼치기'; const noteWrap=document.createElement('div'); noteWrap.className='note'; const ta=document.createElement('textarea'); ta.placeholder='이동/식사/주의사항'; ta.value=s.note||''; ta.addEventListener('input', ()=>{ s.note=ta.value; throttleSave(); }); noteWrap.appendChild(ta); noteBtn.addEventListener('click', ()=>{ const open=noteWrap.style.display==='block'; noteWrap.style.display=open?'none':'block'; noteBtn.textContent=open?'메모 펼치기':'메모 접기'; }); const tools=document.createElement('div'); tools.className='toolbar-inline'; const up=document.createElement('button'); up.className='btn mini'; up.textContent='▲'; const down=document.createElement('button'); down.className='btn mini'; down.textContent='▼'; const linkBtn=document.createElement('button'); linkBtn.className='btn mini'; linkBtn.textContent=s.link?'링크 수정':'링크 추가'; const del=document.createElement('button'); del.className='btn danger mini'; del.textContent='제거'; up.addEventListener('click', ()=> moveItem(index,-1)); down.addEventListener('click', ()=> moveItem(index,+1)); linkBtn.addEventListener('click', ()=>{ const curUrl=s.link||''; const url=prompt('카드 링크(URL, 빈칸=삭제)', curUrl); if(url===null) return; s.link = url.trim()? (/^(https?:)\/\//i.test(url)?url:'https://'+url.trim()) : null; saveState(); renderSchedule(); }); del.addEventListener('click', ()=>{ const c=cur(); const idx=c.schedule.indexOf(s); if(idx>-1){ c.schedule.splice(idx,1); saveState(); renderSchedule(); renderPlanSelect(); }}); tools.appendChild(up); tools.appendChild(down); tools.appendChild(linkBtn); tools.appendChild(del); card.appendChild(img); card.appendChild(body); body.appendChild(noteBtn); body.appendChild(noteWrap); body.appendChild(tools); return card; }
    function moveItem(index, delta){ const c=cur(); const to=index+delta; if(to<0||to>=c.schedule.length) return; const [it]=c.schedule.splice(index,1); c.schedule.splice(to,0,it); saveState(); renderSchedule(); }

    let saveTimer=null; const throttleSave=()=>{ clearTimeout(saveTimer); saveTimer=setTimeout(saveState,800); };
    function bindIntro(){ const intro=byId('intro'); intro.addEventListener('input', ()=>{ const c=cur(); c.intro=intro.innerText; throttleSave(); }); }
    function bindButtons(){ byId('addPlaceBtn').addEventListener('click', addPlace); byId('newPlanBtn').addEventListener('click', createPlan); byId('renamePlanBtn').addEventListener('click', renamePlan); byId('deletePlanBtn').addEventListener('click', deletePlan); }
    function applyState(){ const c=cur(); byId('hTitle').textContent=c.headerTitle||'좌클릭하여 제목을 수정하세요.'; byId('hBadge').textContent=c.headerBadge||'좌클릭하여 설명을 수정하세요.'; byId('intro').innerText=c.intro||''; byId('roomId').value=c.roomId||''; renderPlanSelect(); renderGallery(); renderSchedule(); }

    // ===== Ably realtime =====
    const ABLY_KEY="84KmnQ.XBJyCA:dtalnghkh9M4BwB3rC-gXBDikOu0djb52zWgb0tBuk4"; // TODO: 본인 Ably API Key로 교체
    let rts={ client:null, channel:null, selfId: Math.random().toString(36).slice(2,10), room:null, sync:false };
    let writeTimer=null;
    function pushStateDebounced(){ if(!rts.sync||!rts.channel) return; clearTimeout(writeTimer); writeTimer=setTimeout(()=>{ const payload={ state: cur(), rev: Date.now(), from: rts.selfId }; rts.channel.publish("state", payload); }, 350); }
    async function startSync(roomId){ try{ if(!ABLY_KEY){ alert('Ably API 키를 설정하세요.'); return; } if(!rts.client){ rts.client=new Ably.Realtime({ key: ABLY_KEY }); } rts.room=roomId; rts.channel=rts.client.channels.get("trip:"+roomId); rts.sync=true; rts.channel.subscribe("state",(msg)=>{ const data=msg.data; if(!data) return; if(data.from===rts.selfId) return; const incoming=data.state; const target=cur(); if(target && target.id===incoming.id){ Object.assign(target,incoming); applyState(); saveState(); } }); const url=new URL(location.href); url.searchParams.set('room', roomId); history.replaceState({},'',url); byId('syncToggle').textContent='실시간 동기화: 켜짐'; saveApp(); pushStateDebounced(); }catch(e){ console.error(e); alert('Ably 연결 실패'); } }
    function stopSync(){ if(rts.channel){ rts.channel.detach(()=>{}); rts.channel=null; } rts.sync=false; rts.room=null; const url=new URL(location.href); url.searchParams.delete('room'); history.replaceState({},'',url); byId('syncToggle').textContent='실시간 동기화: 꺼짐'; }
    (function bindRealtimeUI(){ const roomInput=byId('roomId'); const syncBtn=byId('syncToggle'); syncBtn.addEventListener('click', async()=>{ const rid=(roomInput.value||'').trim(); if(!rts.sync){ if(!rid){ alert('공유 코드를 먼저 입력하세요. 예: sapporo-trip'); return; } await startSync(rid); } else { stopSync(); } }); const urlRoom=new URL(location.href).searchParams.get('room'); if(urlRoom){ roomInput.value=urlRoom; startSync(urlRoom); } })();

    function saveState(){ saveApp(); pushStateDebounced(); }

    function init(){ loadApp(); bindHeaderEdit(); bindIntro(); bindButtons(); applyState(); }
    init();
  </script>
</body>
</html>

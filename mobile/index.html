<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>여러 일정 관리 · 모바일 (클린)</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#121821; --muted:#2a3443; --text:#e6edf3; --accent:#53b3ff; --accent2:#82e0aa; --danger:#ff6b6b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif;-webkit-tap-highlight-color:transparent}
    a{color:var(--accent);text-decoration:none}
    button{font:inherit}
    img{max-width:100%;display:block}

    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,15,20,.98),rgba(11,15,20,.85));backdrop-filter:blur(6px);z-index:20}
    .wrap{max-width:860px;margin:0 auto;padding:12px}
    .title{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
    .title h1{margin:0;font-size:20px}
    .badge{font-size:12px;padding:4px 8px;border:1px solid #2a3443;border-radius:999px;color:#b9c4d0}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .select{flex:1;min-width:160px;border:1px solid #334055;background:#0f1620;color:#d7e2ee;padding:10px;border-radius:12px}
    .btn{border:1px solid #344055;background:#141b26;color:#d7e2ee;border-radius:12px;padding:10px 12px;font-size:14px;cursor:pointer;touch-action:manipulation}
    .btn:hover{border-color:#3f5068}
    .btn.danger{border-color:#7a3940;background:#201114;color:#ffc9c9}
    .btn.ghost{background:transparent;border-color:#334055}
    .btn.block{width:100%}

    .explain{margin:12px;background:var(--panel);border:1px solid var(--muted);border-radius:16px;padding:12px}
    .explain [data-editable]{outline:none;border-radius:12px;padding:10px;background:#0e131b;border:1px dashed #394456}
    .explain .hint{font-size:12px;color:#9db0c7;margin-top:6px}

    .board{margin:12px;background:var(--panel);border:1px solid var(--muted);border-radius:16px;padding:12px}
    .board .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap}
    .slots{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px}
    @media (max-width:520px){ .slots{grid-template-columns:1fr;} }

    .card{position:relative;background:#0e151e;border:1px solid #394456;border-radius:14px;overflow:hidden}
    .card img{width:100%;height:120px;object-fit:cover}
    .card .body{padding:10px}
    .card .title{font-size:15px;font-weight:700}
    .noteToggle{margin-top:8px;width:100%;background:#192130;border:1px solid #2b374a;color:#c9d6e2;padding:8px;border-radius:10px;cursor:pointer}
    .note{margin-top:8px;display:none}
    .note textarea{width:100%;min-height:80px;background:#0b1118;color:#d9e4ef;border:1px solid #334055;border-radius:10px;padding:10px;resize:vertical}
    .toolbar-inline{display:flex;gap:8px;margin-top:10px}
    .mini{padding:8px 10px;border-radius:10px;font-size:13px}

    /* Gallery with neutral different tone */
    .gallery{margin:12px;background:#0c1118;border:1px solid #3a4558;border-radius:16px;padding:12px}
    .gallery h3{margin:0 0 8px 0}
    .gallery .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:520px){ .gallery .grid{grid-template-columns:1fr;} }
    .gcard{position:relative;background:#12131a;border:1px solid #3f4a5f;border-radius:14px;overflow:hidden}
    .gcard img{width:100%;height:120px;object-fit:cover}
    .gcard .cap{padding:10px;font-size:14px;color:#cbd6e3}
    .gtools{display:flex;gap:8px;padding:10px;flex-wrap:wrap}

    .footer{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* Modal (custom, no browser dialogs) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;justify-content:center;z-index:50}
    .modal{width:100%;max-width:720px;background:#0f1620;border:1px solid #334055;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px}
    .modal h4{margin:0 0 10px 0}
    .modal .row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .modal input,.modal textarea{width:100%;padding:10px;border:1px solid #324155;background:#0c121b;color:#e6edf3;border-radius:10px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1620;border:1px solid #334055;color:#e6edf3;padding:10px 14px;border-radius:999px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:60}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

    /* Ensure buttons are clickable */
    .btn, .noteToggle { position:relative; z-index:1; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1 id="hTitle" class="editable">좌클릭하여 제목을 수정하세요.</h1>
        <span id="hBadge" class="badge editable">좌클릭하여 설명을 수정하세요.</span>
      </div>
      <div class="toolbar">
        <select id="planSelect" class="select" title="일정 선택"></select>
        <button class="btn" id="newPlanBtn" type="button">새 일정</button>
        <button class="btn" id="renamePlanBtn" type="button">이름 바꾸기</button>
        <button class="btn danger" id="deletePlanBtn" type="button">삭제</button>
      </div>
    </div>
  </header>

  <main>
    <section class="explain">
      <h2 style="margin:0 0 8px 0;font-size:18px">상단: 여행 설명</h2>
      <div id="intro" data-editable="true" contenteditable="true">
        여기에 여행의 목적, 분위기, 이동수단(지하철/렌트/오토바이), 숙소 위치, 예산 등을 자유롭게 적어주세요. 이 텍스트는 자동 저장됩니다.
      </div>
      <div class="hint">Tip: 내용을 수정하면 1초 뒤 자동 저장됩니다.</div>
    </section>

    <section class="board">
      <div class="bar">
        <strong>내 일정</strong>
        <div class="footer">
          <input id="roomId" placeholder="공유 코드(예: sapporo-trip)" style="padding:10px;border-radius:12px;border:1px solid #334055;background:#0e151e;color:#e6edf3;min-width:160px" />
          <button class="btn" id="syncToggle" type="button">실시간 동기화: 꺼짐</button>
        </div>
      </div>
      <div id="schedule" class="slots" aria-label="일정 영역"></div>
    </section>

    <section class="gallery">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>관광지 갤러리</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="addPlaceBtn" type="button">관광지 추가</button>
        </div>
      </div>
      <div id="galleryGrid" class="grid"></div>
    </section>

    <div class="wrap" style="padding:12px 16px 24px;display:flex;justify-content:center">
      <a href="https://pdn4587.github.io/trip/" class="btn ghost block" style="text-align:center">PC 버전으로 보기</a>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </main>

  <script>
    // ========= State =========
    const APP_KEY = 'itinerary-app-v1';
    let app = { activeId: null, items: [] };
    const byId = id => document.getElementById(id);
    const uid = () => Math.random().toString(36).slice(2,9);

    const DEFAULT_GALLERY = [
      { id:"odori", title:"오도리 공원", img:"https://images.unsplash.com/photo-1511732351157-1865efcb7b7b?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"beer", title:"삿포로 맥주 박물관", img:"https://images.unsplash.com/photo-1545431781-c66d5fdbaf93?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"moiwa", title:"모이와 산 로프웨이", img:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"otaru", title:"오타루 운하", img:"https://images.unsplash.com/photo-1587563228632-4f7594dfdf0f?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"nijo", title:"니조 시장", img:"https://images.unsplash.com/photo-1488459716781-31db52582fe9?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"jozankei", title:"조잔케이 온천", img:"https://images.unsplash.com/photo-1501555088652-021faa106b9b?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"clock", title:"삿포로 시계탑", img:"https://images.unsplash.com/photo-1607603751895-d1715e4a7669?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"susukino", title:"스스키노", img:"https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?q=80&w=1200&auto=format&fit=crop", link:null }
    ];

    function newPlanTemplate(name='새 일정'){
      return {
        id: 'plan-'+uid(),
        name,
        headerTitle: '좌클릭하여 제목을 수정하세요.',
        headerBadge: '좌클릭하여 설명을 수정하세요.',
        intro: '',
        schedule: [],
        gallery: [],
        roomId: ''
      };
    }

    function saveApp(){ localStorage.setItem(APP_KEY, JSON.stringify(app)); }
    function loadApp(){
      const raw = localStorage.getItem(APP_KEY);
      if(raw){ try{ app = JSON.parse(raw);}catch{} }
      if(app.items.length===0){ const p=newPlanTemplate('첫 일정'); p.gallery=[...DEFAULT_GALLERY]; app.items.push(p); app.activeId=p.id; saveApp(); }
      if(!app.activeId) app.activeId = app.items[0].id;
    }
    const cur = ()=> app.items.find(p=>p.id===app.activeId);

    // ========= UI Utilities (no browser dialogs) =========
    function toast(msg){
      const el = byId('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.remove('show'), 1400);
    }

    function modal({title='', fields=[], confirmText='확인', cancelText='취소', onConfirm}){
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      const sheet = document.createElement('div');
      sheet.className = 'modal';
      const h = document.createElement('h4'); h.textContent = title; sheet.appendChild(h);
      const inputs = {};
      fields.forEach(f=>{
        const row = document.createElement('div'); row.className='row';
        const label = document.createElement('label'); label.textContent = f.label || ''; row.appendChild(label);
        let input;
        if(f.type==='textarea'){ input = document.createElement('textarea'); input.value = f.value || ''; }
        else { input = document.createElement('input'); input.type = f.type||'text'; input.value = f.value || ''; }
        if(f.placeholder) input.placeholder = f.placeholder;
        if(f.id) inputs[f.id]=input;
        row.appendChild(input);
        sheet.appendChild(row);
      });
      const acts = document.createElement('div'); acts.className='actions';
      const btnCancel = document.createElement('button'); btnCancel.className='btn ghost'; btnCancel.type='button'; btnCancel.textContent=cancelText;
      const btnOk = document.createElement('button'); btnOk.className='btn'; btnOk.type='button'; btnOk.textContent=confirmText;
      acts.appendChild(btnCancel); acts.appendChild(btnOk);
      sheet.appendChild(acts);
      backdrop.appendChild(sheet);
      document.body.appendChild(backdrop);
      const close = ()=> document.body.removeChild(backdrop);
      btnCancel.addEventListener('click', close);
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });
      btnOk.addEventListener('click', ()=>{ if(onConfirm) onConfirm(inputs, close); });
    }

    // ========= Plan controls =========
    function renderPlanSelect(){
      const sel = byId('planSelect'); sel.innerHTML = app.items.map(p => `<option value="${p.id}" ${p.id===app.activeId?'selected':''}>${p.name} (${p.schedule.length})</option>`).join('');
      sel.onchange = ()=> switchPlan(sel.value);
    }
    function switchPlan(id){
      if(id===app.activeId) return;
      stopSync();
      app.activeId = id; saveApp(); applyState();
    }
    function createPlan(){
      modal({
        title:'새 일정',
        fields:[{id:'name', label:'일정 이름', placeholder:'예: 홋카이도 3박4일'}],
        onConfirm:(inp,close)=>{ const name=inp.name.value.trim(); if(!name) return; const p=newPlanTemplate(name); p.gallery=[...DEFAULT_GALLERY]; app.items.push(p); app.activeId=p.id; saveApp(); applyState(); close(); toast('일정이 추가되었습니다'); }
      });
    }
    function renamePlan(){
      const p = cur();
      modal({
        title:'이름 바꾸기',
        fields:[{id:'name', label:'새 이름', value:p.name}],
        onConfirm:(inp,close)=>{ const name=inp.name.value.trim(); if(!name) return; p.name=name; saveApp(); renderPlanSelect(); close(); toast('이름을 변경했습니다'); }
      });
    }
    function deletePlan(){
      if(app.items.length<=1){ toast('마지막 일정은 삭제할 수 없어요'); return; }
      const p = cur();
      modal({
        title:'일정 삭제',
        fields:[{type:'textarea', id:'warn', label:'아래에 "삭제"라고 입력하세요', placeholder:'삭제'}],
        confirmText:'삭제',
        onConfirm:(inp,close)=>{ if(inp.warn.value.trim()!=='삭제') return; const idx=app.items.findIndex(x=>x.id===p.id); app.items.splice(idx,1); app.activeId = app.items[0].id; saveApp(); applyState(); close(); toast('삭제되었습니다'); }
      });
    }

    // ========= Title/Badge edit via modal =========
    function bindHeaderEdit(){
      const hTitle = byId('hTitle'), hBadge = byId('hBadge');
      hTitle.addEventListener('click', ()=>{
        modal({ title:'제목 수정', fields:[{id:'t', label:'제목', value:hTitle.textContent}], onConfirm:(i,close)=>{ const v=i.t.value.trim(); if(v){ hTitle.textContent=v; const c=cur(); c.headerTitle=v; saveState(); close(); toast('제목 저장됨'); } } });
      });
      hBadge.addEventListener('click', ()=>{
        modal({ title:'배지 수정', fields:[{id:'b', label:'배지', value:hBadge.textContent}], onConfirm:(i,close)=>{ const v=i.b.value.trim(); if(v){ hBadge.textContent=v; const c=cur(); c.headerBadge=v; saveState(); close(); toast('배지 저장됨'); } } });
      });
    }

    // ========= Gallery =========
    function renderGallery(){
      const c = cur();
      const list = c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]);
      const grid = byId('galleryGrid'); grid.innerHTML='';
      list.forEach(item=>{
        const card = document.createElement('div'); card.className='gcard';
        card.innerHTML = `
          <img src="${item.img}" alt="${item.title}" draggable="false">
          <div class="cap">${item.title}</div>
          <div class="gtools">
            <button class="btn add" type="button">일정에 추가</button>
            <button class="btn" type="button" data-act="edit">편집</button>
            <button class="btn danger" type="button" data-act="del">삭제</button>
          </div>`;
        card.querySelector('.btn.add').addEventListener('click', ()=>{
          const inst = { uid:uid(), refId:item.id, title:item.title, img:item.img, note:'', link:item.link||null };
          c.schedule.push(inst); saveState(); renderSchedule(); renderPlanSelect(); toast('일정에 추가됨');
        });
        card.querySelector('[data-act="edit"]').addEventListener('click', ()=> editPlace(item.id));
        card.querySelector('[data-act="del"]').addEventListener('click', ()=> removePlace(item.id));
        grid.appendChild(card);
      });
    }
    function addPlace(){
      modal({
        title:'관광지 추가',
        fields:[
          {id:'title', label:'이름'},
          {id:'img', label:'이미지 URL'},
          {id:'link', label:'링크(URL, 선택)'}
        ],
        onConfirm:(inp,close)=>{
          const title=inp.title.value.trim(), img=inp.img.value.trim(); if(!title||!img) return;
          const link=inp.link.value.trim(); const id = title.toLowerCase().replace(/\s+/g,'-')+'-'+uid();
          const c=cur(); const list = c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]);
          list.push({ id, title, img, link: link? (/^(https?:)\/\//i.test(link)?link:'https://'+link) : null });
          saveState(); renderGallery(); close(); toast('관광지 추가됨');
        }
      });
    }
    function editPlace(id){
      const c=cur(); const list=c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]);
      const g=list.find(x=>x.id===id); if(!g) return;
      modal({
        title:'관광지 편집',
        fields:[
          {id:'title', label:'이름', value:g.title},
          {id:'img', label:'이미지 URL', value:g.img},
          {id:'link', label:'링크(URL, 선택)', value:g.link||''}
        ],
        onConfirm:(inp,close)=>{
          g.title = inp.title.value.trim()||g.title;
          g.img = inp.img.value.trim() || g.img;
          const link = inp.link.value.trim();
          g.link = link ? (/^(https?:)\/\//i.test(link)?link:'https://'+link) : null;
          saveState(); renderGallery(); renderSchedule(); close(); toast('저장됨');
        }
      });
    }
    function removePlace(id){
      const c=cur(); const list=c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]);
      const idx = list.findIndex(x=>x.id===id); if(idx<0) return;
      modal({
        title:'갤러리에서 삭제',
        fields:[{id:'ok', label:'"삭제" 입력', placeholder:'삭제'}],
        confirmText:'삭제',
        onConfirm:(inp,close)=>{
          if(inp.ok.value.trim()!=='삭제') return;
          list.splice(idx,1); saveState(); renderGallery(); close(); toast('삭제됨');
        }
      });
    }

    // ========= Schedule =========
    function renderSchedule(){
      const c=cur(); const el=byId('schedule'); el.innerHTML='';
      c.schedule.forEach((s,i)=> el.appendChild(makeSchedCard(s,i)) );
    }
    function makeSchedCard(s, index){
      const card = document.createElement('div'); card.className='card';
      const img = document.createElement('img'); img.src=s.img; img.alt=s.title; img.draggable=false;
      img.addEventListener('click', ()=>{ if(s.link) window.open(s.link,'_blank'); });
      const body = document.createElement('div'); body.className='body';
      const t = document.createElement('div'); t.className='title'; t.textContent=s.title; body.appendChild(t);

      const noteBtn = document.createElement('button'); noteBtn.className='noteToggle btn mini'; noteBtn.textContent='메모 펼치기';
      const noteWrap = document.createElement('div'); noteWrap.className='note';
      const ta = document.createElement('textarea'); ta.placeholder='이동/식사/주의사항 등을 적어주세요'; ta.value=s.note||'';
      ta.addEventListener('input', ()=>{ s.note=ta.value; throttleSave(); });
      noteWrap.appendChild(ta);
      noteBtn.addEventListener('click', ()=>{ const open = noteWrap.style.display==='block'; noteWrap.style.display = open? 'none':'block'; noteBtn.textContent = open? '메모 펼치기':'메모 접기'; });

      const tools = document.createElement('div'); tools.className='toolbar-inline';
      const up = document.createElement('button'); up.className='btn mini'; up.type='button'; up.textContent='▲';
      const down = document.createElement('button'); down.className='btn mini'; down.type='button'; down.textContent='▼';
      const linkBtn = document.createElement('button'); linkBtn.className='btn mini'; linkBtn.type='button'; linkBtn.textContent = s.link? '링크 수정':'링크 추가';
      const del = document.createElement('button'); del.className='btn danger mini'; del.type='button'; del.textContent='제거';

      up.addEventListener('click', ()=> moveItem(index,-1));
      down.addEventListener('click', ()=> moveItem(index,+1));
      linkBtn.addEventListener('click', ()=>{
        modal({
          title:'링크 설정',
          fields:[{id:'url', label:'URL', value: s.link || '', placeholder:'https://...'}],
          onConfirm:(inp,close)=>{ const v=inp.url.value.trim(); s.link = v? (/^(https?:)\/\//i.test(v)?v:'https://'+v) : null; saveState(); renderSchedule(); close(); toast('링크 저장됨'); }
        });
      });
      del.addEventListener('click', ()=>{
        modal({
          title:'일정에서 제거',
          fields:[{id:'ok', label:'"삭제" 입력', placeholder:'삭제'}],
          confirmText:'삭제',
          onConfirm:(inp,close)=>{
            if(inp.ok.value.trim()!=='삭제') return;
            const c=cur(); const idx = c.schedule.indexOf(s); if(idx>-1){ c.schedule.splice(idx,1); saveState(); renderSchedule(); renderPlanSelect(); }
            close(); toast('제거됨');
          }
        });
      });

      tools.appendChild(up); tools.appendChild(down); tools.appendChild(linkBtn); tools.appendChild(del);
      card.appendChild(img); card.appendChild(body); body.appendChild(noteBtn); body.appendChild(noteWrap); body.appendChild(tools);
      return card;
    }
    function moveItem(index, delta){
      const c=cur(); const to=index+delta; if(to<0 || to>=c.schedule.length) return;
      const [it] = c.schedule.splice(index,1); c.schedule.splice(to,0,it); saveState(); renderSchedule();
    }

    // ========= Bindings & Apply =========
    let saveTimer=null; const throttleSave = ()=>{ clearTimeout(saveTimer); saveTimer=setTimeout(saveState,800); };
    function bindIntro(){ const intro=byId('intro'); intro.addEventListener('input', ()=>{ const c=cur(); c.intro=intro.innerText; throttleSave(); }); }
    function bindButtons(){
      byId('addPlaceBtn').addEventListener('click', addPlace);
      byId('newPlanBtn').addEventListener('click', createPlan);
      byId('renamePlanBtn').addEventListener('click', renamePlan);
      byId('deletePlanBtn').addEventListener('click', deletePlan);
    }
    function applyState(){
      const c = cur();
      byId('hTitle').textContent = c.headerTitle || '좌클릭하여 제목을 수정하세요.';
      byId('hBadge').textContent = c.headerBadge || '좌클릭하여 설명을 수정하세요.';
      byId('intro').innerText = c.intro || '';
      byId('roomId').value = c.roomId || '';
      renderPlanSelect();
      renderGallery();
      renderSchedule();
    }

    // ========= Realtime Sync =========
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBnE9puYTVB3tSkCWf7G9um0Rx36jY1qcA",
      authDomain: "trip-ece7e.firebaseapp.com",
      projectId: "trip-ece7e",
    };
    let fb = { app:null, db:null, auth:null, unsub:null, sync:false, room:null, selfId: Math.random().toString(36).slice(2,10) };
    async function initFirebase(){ if(fb.app) return; if(!FIREBASE_CONFIG.apiKey){ console.warn('Firebase 미설정'); return; } fb.app = firebase.initializeApp(FIREBASE_CONFIG); fb.db = firebase.firestore(); fb.auth = firebase.auth(); try{ await fb.auth.signInAnonymously(); }catch(e){ console.warn(e); } try{ await fb.db.enablePersistence({ synchronizeTabs: true }); }catch(e){} }
    const roomDoc = (roomId)=> fb.db.collection('rooms').doc(roomId);
    let writeTimer=null; let lastRemoteRev = 0;
    function pushStateDebounced(){ if(!fb.sync || !fb.room) return; clearTimeout(writeTimer); writeTimer = setTimeout(async()=>{ try{ const payload = { state: cur(), rev: Date.now(), from: fb.selfId }; await roomDoc(fb.room).set(payload, { merge: true }); }catch(e){ console.error(e); } }, 350); }
    async function startSync(roomId){
      await initFirebase();
      if(!fb.db){ toast('Firebase 설정 필요'); return; }
      const c=cur();
      c.roomId = roomId;
      fb.room = roomId;
      fb.sync = true;
      await roomDoc(roomId).set({ state: c, rev: Date.now(), from: fb.selfId }, { merge: true });
      if(fb.unsub) fb.unsub();
      fb.unsub = roomDoc(roomId).onSnapshot((snap)=>{
        const data = snap.data();
        if(!data) return;
        if(data.from === fb.selfId) return;
        if(data.rev && data.rev <= lastRemoteRev) return;
        lastRemoteRev = data.rev || Date.now();
        const incoming = data.state;
        const target = cur();
        if(target && target.id===incoming.id){
          Object.assign(target, incoming);
          applyState();
          saveState();
        }
      });
      const url = new URL(location.href);
      url.searchParams.set('room', roomId);
      history.replaceState({}, '', url);
      byId('syncToggle').textContent = '실시간 동기화: 켜짐';
      saveApp();
    }
    function stopSync(){
      if(fb.unsub) fb.unsub();
      fb.unsub=null; fb.sync=false; fb.room=null;
      const url = new URL(location.href);
      url.searchParams.delete('room');
      history.replaceState({}, '', url);
      byId('syncToggle').textContent = '실시간 동기화: 꺼짐';
    }
    (function bindRealtimeUI(){
      const roomInput = byId('roomId'); const syncBtn = byId('syncToggle');
      syncBtn.addEventListener('click', async()=>{
        const rid = (roomInput.value||'').trim();
        if(!fb.sync){
          if(!rid){ toast('공유 코드를 먼저 입력하세요'); return; }
          await startSync(rid);
        } else { stopSync(); }
      });
      const urlRoom = new URL(location.href).searchParams.get('room');
      if(urlRoom){ roomInput.value = urlRoom; startSync(urlRoom); }
    })();

    // ========= Save State =========
    function saveState(){ saveApp(); pushStateDebounced(); }

    // ========= Init =========
    function init(){
      loadApp();
      bindHeaderEdit();
      bindIntro();
      bindButtons();
      applyState();
    }
    init();
  </script>
</body>
</html>

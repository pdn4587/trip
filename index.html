<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>여러 일정 관리 · 통합(PC/모바일) · Ably 자동 동기화 + iOS 전용 터치 DnD (감도조절)</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#121821; --muted:#2a3443; --text:#e6edf3; --accent:#53b3ff; --accent2:#82e0aa; --danger:#ff6b6b;
      --gallery-bg:#0c1118; --gallery-bd:#3a4558; --gallery-card:#12131a; --gallery-card-bd:#3f4a5f;
      --tabbar-bg:#0f1620; --tabbar-bd:#2b3546; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif;-webkit-tap-highlight-color:transparent}
    a{color:var(--accent);text-decoration:none}
    /* iOS에서만 적용할 옵션 차단을 위해 body.ios에만 묶음 */
    body.ios img{ -webkit-user-drag:none; -webkit-touch-callout:none }
    body.ios .gcard, body.ios .card{ -webkit-user-drag:none; -webkit-touch-callout:none }
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:#0a0f16;border-right:1px solid #1f2a3a;position:sticky;top:0;height:100vh;overflow:auto}
    .main{flex:1;min-width:0}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,15,20,.98),rgba(11,15,20,.85));backdrop-filter:blur(6px);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .title{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .title h1{margin:0;font-size:22px;cursor:pointer}
    .badge{font-size:12px;padding:4px 8px;border:1px solid var(--muted);border-radius:999px;color:#b9c4d0;cursor:pointer}
    .side-head{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid #1f2a3a}
    .side-head b{font-size:14px;color:#c7d2e1}
    .side-list{padding:8px;display:flex;flex-direction:column;gap:8px}
    .tab{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid #223046;border-radius:10px;background:#0d1320;cursor:pointer}
    .tab.active{border-color:#39557a;box-shadow:0 0 0 2px rgba(83,179,255,.15) inset}
    .tab .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tab .sub{font-size:11px;color:#9fb1c9}
    .side-actions{padding:8px}
    .side-actions .btn{width:100%}
    .btn{border:1px solid #344055;background:#141b26;color:#d7e2ee;border-radius:8px;padding:8px 10px;font-size:12px;cursor:pointer}
    .btn:hover{border-color:#3f5068}
    .btn.danger{border-color:#7a3940;background:#201114;color:#ffc9c9}
    .explain{margin-top:10px;background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:14px}
    .explain [contenteditable]{outline:none;border-radius:10px;padding:8px;background:#0e131b;border:1px dashed #394456}
    .explain .hint{font-size:12px;color:#9db0c7;margin-top:6px}
    .board{margin-top:14px;background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:12px}
    .board .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap}
    .board .slots{display:grid;grid-template-columns:repeat(auto-fill,180px);gap:12px;align-items:start}
    .card{position:relative;background:#0e151e;border:1px solid #394456;border-radius:12px;overflow:hidden;width:180px}
    .card img{display:block;width:100%;height:110px;object-fit:cover}
    .card .body{padding:8px}
    .card .title{font-size:14px;font-weight:600}
    .card .noteToggle{margin-top:6px;width:100%;background:#192130;border:1px solid #2b374a;color:#c9d6e2;padding:6px;border-radius:8px;cursor:pointer}
    .card .note{margin-top:8px;display:none}
    .card .note textarea{width:100%;min-height:70px;background:#0b1118;color:#d9e4ef;border:1px solid #334055;border-radius:8px;padding:8px;resize:vertical}
    .card .toolbar{position:absolute;top:6px;right:6px;display:flex;gap:6px}
    .card.flow-right::after{content:"";position:absolute;right:-12px;top:50%;transform:translateY(-50%);width:12px;height:2px;background:#3c5674}
    .card.flow-right::before{content:"›";position:absolute;right:-16px;top:50%;transform:translateY(-50%);font-weight:800;color:#7fa6d1}
    .card.flow-down::after{content:"";position:absolute;left:50%;bottom:-12px;transform:translateX(-50%);width:2px;height:12px;background:#3c5674}
    .card.flow-down::before{content:"⌄";position:absolute;left:50%;bottom:-20px;transform:translateX(-50%);font-weight:800;color:#7fa6d1}
    .card.no-flow::after,.card.no-flow::before{display:none}
    .link-dot{position:absolute;top:8px;left:8px;width:10px;height:10px;border-radius:50%;background:var(--accent2);box-shadow:0 0 0 2px rgba(130,224,170,.25)}
    .add-slot{width:180px;min-height:110px;background:#0e151e;border:1px dashed #394456;border-radius:12px;color:#7d8aa1;display:flex;align-items:center;justify-content:center;font-size:14px}
    .add-slot.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(83,179,255,.2) inset}
    .placeholder{width:180px;min-height:110px;border:2px dashed #5a90ff;border-radius:12px;background:#0c1220AA;display:flex;align-items:center;justify-content:center;font-size:13px;color:#bcd3ff}
    .gallery{margin:16px 0;background:var(--gallery-bg);border:1px solid var(--gallery-bd);border-radius:14px;padding:12px}
    .gallery .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .gallery .gcard{position:relative;background:var(--gallery-card);border:1px solid var(--gallery-card-bd);border-radius:12px;overflow:hidden;cursor:grab}
    .gallery .gcard:active{cursor:grabbing}
    .gcard img{display:block;width:100%;height:120px;object-fit:cover}
    .gcard .cap{padding:8px;font-size:13px;color:#cbd6e3}
    .gcard .gtools{position:absolute;top:6px;right:6px;display:flex;gap:6px}
    .footer{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:#2b374a;border-radius:999px}
    body.dragging{ user-select:none; cursor:grabbing; }

    /* 모바일 레이아웃 */
    @media (max-width: 900px){
      .app{display:block}
      .sidebar{display:none}
      .wrap{padding:14px}
      .board .slots .card{width:100%}
      .add-slot{width:100%}
    }

    /* 모바일 하단 탭바 */
    .mobile-tabbar{
      position: sticky; bottom: 0; z-index: 50;
      background: var(--tabbar-bg); border-top:1px solid var(--tabbar-bd);
      padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
      display: none; gap:8px; align-items:center; justify-content:stretch; flex-wrap:wrap;
    }
    .mobile-tabbar .row{display:flex; gap:8px; width:100%; align-items:center}
    .mobile-tabbar .select{flex:1; min-width:160px; border:1px solid #334055; background:#0f1620; color:#d7e2ee; padding:8px; border-radius:10px}
    .iconbtn{min-width:40px; border-radius:10px; padding:8px 10px}
    @media (max-width: 900px){
      .mobile-tabbar{display:flex}
    }

    .drag-ghost{position:fixed; pointer-events:none; z-index:9999; opacity:.9; transform:translate(-50%,-50%); border-radius:8px; overflow:hidden; box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .drag-ghost img{display:block; width:140px; height:90px; object-fit:cover}
  </style>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="side-head">
        <b>내 일정들</b>
        <button class="btn" id="newPlanBtn">새 일정</button>
      </div>
      <div id="tabList" class="side-list"></div>
      <div class="side-actions">
        <button class="btn" id="renamePlanBtn">이 일정 이름 바꾸기</button>
        <button class="btn danger" id="deletePlanBtn">이 일정 삭제</button>
      </div>
    </aside>

    <div class="main">
      <header>
        <div class="wrap">
          <div class="title">
            <h1 id="hTitle">좌클릭하여 제목을 수정하세요.</h1>
            <span id="hBadge" class="badge">좌클릭하여 설명을 수정하세요.</span>
          </div>
        </div>
      </header>

      <main class="wrap">
        <section class="explain">
          <h2 style="margin:0 0 8px 0;font-size:18px">상단: 여행 설명</h2>
          <div id="intro" contenteditable="true">여기에 여행의 목적, 분위기, 이동수단, 숙소 위치, 예산 등을 자유롭게 적어주세요.</div>
          <div class="hint">Tip: 내용을 수정하면 1초 뒤 자동 저장됩니다.</div>
        </section>

        <section class="board">
          <div class="bar">
            <strong>내 일정 (갤러리에서 끌어 추가 / 드래그로 순서변경)</strong>
          </div>
          <div id="schedule" class="slots" aria-label="일정 드롭 영역"></div>
        </section>

        <section class="gallery">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>관광지 갤러리</strong>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="addPlaceBtn">관광지 추가</button>
            </div>
          </div>
          <div id="galleryGrid" class="grid"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- 모바일 하단 탭바 -->
  <div class="mobile-tabbar" id="mobileTabbar" aria-label="모바일 탭 조작">
    <div class="row">
      <button class="btn iconbtn" id="prevPlanBtn" title="이전 일정">◀</button>
      <select id="planSelect" class="select" title="일정 선택"></select>
      <button class="btn iconbtn" id="nextPlanBtn" title="다음 일정">▶</button>
    </div>
    <div class="row">
      <button class="btn" id="mNew">새 일정</button>
      <button class="btn" id="mRename">이 일정 이름 바꾸기</button>
      <button class="btn danger" id="mDelete">이 일정 삭제</button>
    </div>
  </div>

  <script>
    // ===== 유틸: iOS 감지 (iPadOS까지) =====
    const isIOS = (()=>{
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const iOS = /iPad|iPhone|iPod/.test(ua);
      const iPadOS13 = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      return iOS || iPadOS13;
    })();
    if(isIOS){ document.body.classList.add('ios'); }

    // ===== 기본 데이터 =====
    const DEFAULT_GALLERY = [
      { id:"odori", title:"오도리 공원", img:"https://images.unsplash.com/photo-1511732351157-1865efcb7b7b?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"beer", title:"삿포로 맥주 박물관", img:"https://images.unsplash.com/photo-1545431781-c66d5fdbaf93?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"moiwa", title:"모이와 산 로프웨이", img:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"otaru", title:"오타루 운하", img:"https://images.unsplash.com/photo-1587563228632-4f7594dfdf0f?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"nijo", title:"니조 시장", img:"https://images.unsplash.com/photo-1488459716781-31db52582fe9?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"jozankei", title:"조잔케이 온천", img:"https://images.unsplash.com/photo-1501555088652-021faa106b9b?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"clock", title:"삿포로 시계탑", img:"https://images.unsplash.com/photo-1607603751895-d1715e4a7669?q=80&w=1200&auto=format&fit=crop", link:null },
      { id:"susukino", title:"스스키노", img:"https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?q=80&w=1200&auto=format&fit=crop", link:null }
    ];

    // ===== 앱 상태 =====
    const APP_KEY = 'itinerary-app-v1';
    let app = { activeId: null, items: [] };
    const byId = id => document.getElementById(id);
    const uid = () => Math.random().toString(36).slice(2,9);
    const cur = ()=> app.items.find(p=>p.id===app.activeId);

    function newPlanTemplate(name='새 일정'){
      return { id:'plan-'+uid(), name, headerTitle:'좌클릭하여 제목을 수정하세요.', headerBadge:'좌클릭하여 설명을 수정하세요.', intro:'', schedule:[], gallery:[...DEFAULT_GALLERY], roomId:'' };
    }
    function saveApp(){ localStorage.setItem(APP_KEY, JSON.stringify(app)); }
    function loadApp(){
      const raw = localStorage.getItem(APP_KEY); if(raw){ try{ app = JSON.parse(raw);}catch{} }
      if(app.items.length===0){ const p=newPlanTemplate('첫 일정'); app.items.push(p); app.activeId=p.id; saveApp(); }
      if(!app.activeId) app.activeId = app.items[0].id;
    }
    function saveState(){ saveApp(); pushStateDebounced(); }

    // ===== 탭 & 모바일 셀렉터 =====
    function renderTabs(){
      const list = byId('tabList'); if(list){ list.innerHTML=''; }
      app.items.forEach(p=>{
        if(list){
          const el = document.createElement('div'); el.className='tab'+(p.id===app.activeId?' active':'');
          el.innerHTML = `<div class="name">${p.name}</div><div class="sub">${p.schedule.length}개 일정</div>`;
          el.addEventListener('click', ()=> switchPlan(p.id));
          el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); tabContextMenu(p.id); });
          list.appendChild(el);
        }
      });
      // 모바일 하단 select 갱신
      const sel = byId('planSelect');
      if(sel){
        sel.innerHTML = app.items.map(p=>`<option value="${p.id}" ${p.id===app.activeId?'selected':''}>${p.name} (${p.schedule.length})</option>`).join('');
        sel.onchange = ()=> switchPlan(sel.value);
      }
    }
    function tabContextMenu(id){
      const actions = prompt('원하는 작업: 이름변경 / 삭제 / 복제', '이름변경');
      if(!actions) return;
      if(actions.includes('이름')) renamePlan(id);
      else if(actions.includes('삭제')) deletePlan(id);
      else if(actions.includes('복제')) duplicatePlan(id);
    }
    function switchPlan(id){ if(id===app.activeId) return; app.activeId=id; saveState(); applyState(); renderTabs(); }
    function createPlan(){ const name=prompt('새 일정 이름','새 일정'); if(!name) return; const p=newPlanTemplate(name.trim()); app.items.push(p); app.activeId=p.id; saveState(); applyState(); renderTabs(); }
    function renamePlan(id){ const p=app.items.find(x=>x.id===id) || cur(); if(!p) return; const name=prompt('일정 이름', p.name); if(name===null) return; p.name=name.trim()||p.name; saveState(); renderTabs(); }
    function deletePlan(id){ const idx=app.items.findIndex(x=>x.id===(id||app.activeId)); if(idx<0) return; if(app.items.length<=1){ alert('마지막 일정은 삭제할 수 없어요'); return; } app.items.splice(idx,1); app.activeId=app.items[0].id; saveState(); applyState(); renderTabs(); }
    function duplicatePlan(id){
      const p = app.items.find(x=>x.id===(id||app.activeId)); if(!p) return;
      const copy = JSON.parse(JSON.stringify(p)); copy.id = 'plan-'+uid(); copy.name = p.name + ' 복사';
      app.items.push(copy); app.activeId = copy.id; saveState(); applyState(); renderTabs();
    }

    // 모바일 하단 탭바 버튼 바인딩 (복제 제거)
    function bindMobileTabbar(){
      byId('mNew').addEventListener('click', createPlan);
      byId('mRename').addEventListener('click', ()=> renamePlan(app.activeId));
      byId('mDelete').addEventListener('click', ()=> deletePlan(app.activeId));
      byId('prevPlanBtn').addEventListener('click', ()=>{
        const idx = app.items.findIndex(p=>p.id===app.activeId);
        const next = (idx-1+app.items.length)%app.items.length;
        switchPlan(app.items[next].id);
      });
      byId('nextPlanBtn').addEventListener('click', ()=>{
        const idx = app.items.findIndex(p=>p.id===app.activeId);
        const next = (idx+1)%app.items.length;
        switchPlan(app.items[next].id);
      });
    }

    // ===== 제목/배지 클릭 편집 =====
    function bindHeaderEdit(){
      const hTitle = byId('hTitle'); const hBadge = byId('hBadge');
      const edit = (el,key,msg)=> el.addEventListener('click', ()=>{ const c=cur(); const val = prompt(msg, c[key] || el.textContent); if(val===null) return; el.textContent = (val.trim()||el.textContent); c[key]=el.textContent; saveState(); });
      edit(hTitle,'headerTitle','페이지 제목을 입력하세요');
      edit(hBadge,'headerBadge','배지 캡션을 입력하세요');
    }

    // ===== 갤러리 =====
    function renderGallery(){
      const c=cur(); const list = c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]);
      const grid = byId('galleryGrid'); grid.innerHTML='';
      list.forEach(item=>{
        const card = document.createElement('div'); card.className='gcard'; card.draggable=true; card.dataset.role='gallery-card'; card.dataset.gid=item.id;
        card.addEventListener('dragstart', e=> setDrag(e,{type:'gallery', id:item.id}));
        card.innerHTML = `
          <img src="${item.img}" alt="${item.title}">
          <div class="cap">${item.title}</div>
          <div class="gtools">
            <button class="btn" title="편집" type="button">편집</button>
            <button class="btn danger" title="삭제" type="button">삭제</button>
          </div>`;
        card.addEventListener('contextmenu', (e)=>{ e.preventDefault(); editPlace(item.id); });
        card.querySelector('[title="편집"]').addEventListener('click', ()=> editPlace(item.id));
        card.querySelector('[title="삭제"]').addEventListener('click', ()=> removePlace(item.id));
        if(isIOS){ enableTouchSource(card, {type:'gallery', id:item.id, img:item.img, title:item.title}); }
        grid.appendChild(card);
      });
    }
    function addPlace(){
      const c=cur(); const title=prompt('여행지 이름'); if(!title) return; const img=prompt('대표 이미지 URL'); if(!img) return;
      const link = prompt('기본 링크(URL, 선택)')||null;
      const id = title.toLowerCase().replace(/\s+/g,'-')+'-'+uid();
      const item = { id, title, img, link: link&&link.trim()? (/^(https?:)\/\//i.test(link)?link:'https://'+link.trim()): null };
      const list = c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]);
      list.push(item); saveState(); renderGallery();
    }
    function editPlace(id){
      const c=cur(); const list=c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]); const idx=list.findIndex(x=>x.id===id); if(idx<0) return;
      const g=list[idx];
      const title = prompt('여행지 이름', g.title); if(title===null) return;
      const img = prompt('대표 이미지 URL', g.img); if(img===null) return;
      const link = prompt('기본 링크(URL, 비우면 없음)', g.link||''); if(link===null) return;
      g.title = title.trim()||g.title; g.img = img.trim()||g.img; g.link = link.trim()? (/^(https?:)\/\//i.test(link)?link:'https://'+link.trim()) : null;
      saveState(); renderGallery(); renderSchedule();
    }
    function removePlace(id){
      const c=cur(); const list=c.gallery && c.gallery.length ? c.gallery : (c.gallery=[...DEFAULT_GALLERY]);
      const idx = list.findIndex(x=>x.id===id); if(idx<0) return;
      list.splice(idx,1); saveState(); renderGallery();
    }

    // ===== 드래그 & 드롭 (데스크톱/안드로이드: 네이티브 유지) =====
    const setDrag = (ev,payload)=>{ ev.dataTransfer.setData('application/json', JSON.stringify(payload)); ev.dataTransfer.effectAllowed='move'; };
    const getDrag = (ev)=>{ try{ return JSON.parse(ev.dataTransfer.getData('application/json')); }catch{ return null } };
    const placeholder = document.createElement('div'); placeholder.className='placeholder'; placeholder.textContent='여기에 놓기';
    let dragCtx=null; let dropLock=false;
    function applyDrop(payload, insertAt){
      if(dropLock) return; dropLock=true;
      try{
        const c=cur();
        if(payload.type==='gallery'){
          const src=findGalleryById(payload.id); if(!src) return;
          const inst={ uid:uid(), refId:src.id, title:src.title, img:src.img, note:'', link:src.link||null };
          if(typeof insertAt==='number' && insertAt>=0 && insertAt<=c.schedule.length){ c.schedule.splice(insertAt,0,inst); } else { c.schedule.push(inst); }
        } else if(payload.type==='schedule'){
          const from=payload.from; if(from==null) return; let target=(typeof insertAt==='number')? insertAt : c.schedule.length;
          if(from===target || from+1===target) return;
          const moved=c.schedule.splice(from,1)[0];
          const fixed=(target>from)? target-1 : target; if(fixed>=c.schedule.length) c.schedule.push(moved); else c.schedule.splice(fixed,0,moved);
        }
        saveState(); renderSchedule();
      } finally { setTimeout(()=> dropLock=false, 0); }
    }

    function renderSchedule(){
      const c=cur(); const el=byId('schedule'); el.innerHTML='';
      c.schedule.forEach((s,i)=> el.appendChild(makeSchedCard(s,i)) );
      el.appendChild(makeAddSlot()); bindScheduleDnD(); requestAnimationFrame(updateFlowArrows);
    }
    function makeAddSlot(){
      const add=document.createElement('div'); add.className='add-slot'; add.textContent='+ 여기에 놓기'; add.title='갤러리에서 끌어다 추가';
      add.addEventListener('dragover', (e)=>{ e.preventDefault(); e.stopPropagation(); add.classList.add('active'); });
      add.addEventListener('dragleave', ()=> add.classList.remove('active'));
      add.addEventListener('drop', (e)=>{ e.preventDefault(); e.stopPropagation(); add.classList.remove('active'); const payload=dragCtx||getDrag(e); if(!payload) return; const c=cur(); applyDrop(payload, c.schedule.length); });
      if(isIOS){ enableTouchDrop(add, (insertAt)=> insertAt===-1 ? null : applyDrop(touchDragging.payload, insertAt)); }
      return add;
    }
    function makeSchedCard(s, index){
      const card=document.createElement('div'); card.className='card'; card.setAttribute('draggable','true'); card.dataset.index=index; card.dataset.role='schedule-card';
      card.addEventListener('dragstart', e=>{ dragCtx={type:'schedule', from:index}; setDrag(e,dragCtx); document.body.classList.add('dragging'); });
      card.addEventListener('dragend', ()=>{ dragCtx=null; document.body.classList.remove('dragging'); removePlaceholder(); });
      card.addEventListener('dragover', e=>{ e.preventDefault(); positionPlaceholder(card,e); });
      card.addEventListener('drop', e=>{ e.preventDefault(); e.stopPropagation(); const payload=dragCtx||getDrag(e); if(!payload) return; const insertAt=placeholderIndex(); if(insertAt===-1){ removePlaceholder(); return; } applyDrop(payload, insertAt); });

      const img=document.createElement('img'); img.src=s.img; img.alt=s.title;
      img.addEventListener('click', ()=>{ if(s.link) window.open(s.link,'_blank'); });
      img.addEventListener('contextmenu', (e)=>{ e.preventDefault(); const curp=cur(); const curUrl=s.link||''; const url=prompt('카드 링크(URL, 빈칸=삭제)', curUrl); if(url===null) return; s.link = url.trim()? (/^(https?:)\/\//i.test(url)?url:'https://'+url.trim()) : null; saveState(); renderSchedule(); });

      const body=document.createElement('div'); body.className='body';
      const t=document.createElement('div'); t.className='title'; t.textContent=s.title; body.appendChild(t);

      const noteBtn=document.createElement('button'); noteBtn.className='noteToggle'; noteBtn.textContent='메모 펼치기';
      const noteWrap=document.createElement('div'); noteWrap.className='note';
      const ta=document.createElement('textarea'); ta.placeholder='이동/식사/주의사항'; ta.value=s.note||'';
      ta.addEventListener('input', ()=>{ s.note=ta.value; throttleSave(); });
      noteWrap.appendChild(ta);
      noteBtn.addEventListener('click', ()=>{ const open=noteWrap.style.display==='block'; noteWrap.style.display=open?'none':'block'; noteBtn.textContent=open?'메모 펼치기':'메모 접기'; });

      const tools=document.createElement('div'); tools.className='toolbar';
      const del=document.createElement('button'); del.className='btn danger'; del.textContent='제거';
      del.addEventListener('click', ()=>{ const c=cur(); const idx=c.schedule.indexOf(s); if(idx>-1){ c.schedule.splice(idx,1); saveState(); renderSchedule(); }});
      const linkBtn=document.createElement('button'); linkBtn.className='btn'; linkBtn.textContent=s.link?'링크 수정':'링크 추가';
      linkBtn.addEventListener('click', ()=> img.dispatchEvent(new MouseEvent('contextmenu',{bubbles:true,cancelable:true})) );
      tools.appendChild(linkBtn); tools.appendChild(del);

      if(s.link){ const dot=document.createElement('div'); dot.className='link-dot'; card.appendChild(dot); img.title=s.link; }
      card.appendChild(img); card.appendChild(body); body.appendChild(noteBtn); body.appendChild(noteWrap); card.appendChild(tools);

      if(isIOS){
        enableTouchSource(card, {type:'schedule', from:index, img:s.img, title:s.title});
        enableTouchDrop(card, (insertAt)=> insertAt===-1 ? null : applyDrop(touchDragging.payload, insertAt));
      }
      return card;
    }
    function bindScheduleDnD(){ const cont=byId('schedule'); cont.addEventListener('dragover', (e)=> e.preventDefault()); cont.addEventListener('drop', (e)=>{ e.preventDefault(); e.stopPropagation(); if(e.target && e.target.classList && e.target.classList.contains('add-slot')) return; const payload=dragCtx||getDrag(e); if(!payload) return; const idx=placeholderIndex(); const c=cur(); applyDrop(payload, (idx!==-1? idx : c.schedule.length)); removePlaceholder(); }); }
    function positionPlaceholder(targetCard,e){ const cont=byId('schedule'); const r=targetCard.getBoundingClientRect(); const midY=r.top+r.height/2; const midX=r.left+r.width/2; let after=e.clientY>midY; if(Math.abs(e.clientY-midY)<r.height*0.25) after=e.clientX>midX; if(after){ targetCard.after(placeholder);} else { cont.insertBefore(placeholder,targetCard);} }
    function placeholderIndex(){ const cont=byId('schedule'); const nodes=Array.from(cont.children).filter(el=> el.classList.contains('card')||el.classList.contains('placeholder')); return nodes.indexOf(placeholder); }
    function removePlaceholder(){ if(placeholder.parentElement) placeholder.parentElement.removeChild(placeholder); }
    function findGalleryById(id){ const c=cur(); const list=c.gallery && c.gallery.length ? c.gallery : DEFAULT_GALLERY; return list.find(g=>g.id===id); }
    let saveTimer=null; const throttleSave=()=>{ clearTimeout(saveTimer); saveTimer=setTimeout(saveState,800); };
    function bindIntro(){ const intro=byId('intro'); intro.addEventListener('input', ()=>{ const c=cur(); c.intro=intro.innerText; throttleSave(); }); }
    function bindButtons(){
      byId('addPlaceBtn').addEventListener('click', addPlace);
      byId('newPlanBtn')?.addEventListener('click', createPlan);
      byId('renamePlanBtn')?.addEventListener('click', ()=> renamePlan(app.activeId));
      byId('deletePlanBtn')?.addEventListener('click', ()=> deletePlan(app.activeId));
      bindMobileTabbar();
    }
    function updateFlowArrows(){
      const cont=byId('schedule');
      const cards=Array.from(cont.querySelectorAll('.card'));
      cards.forEach(c=> c.classList.remove('flow-right','flow-down','no-flow') );
      requestAnimationFrame(()=>{
        for(let i=0;i<cards.length;i++){
          const c=cards[i]; const n=cards[i+1];
          if(!n){ c.classList.add('no-flow'); break; }
          const r1=c.getBoundingClientRect(); const r2=n.getBoundingClientRect();
          if(Math.abs(r1.top-r2.top)<10){ c.classList.add('flow-right'); } else { c.classList.add('flow-down'); }
        }
      });
    }
    function applyState(){
      const c=cur();
      byId('hTitle').textContent=c.headerTitle||'좌클릭하여 제목을 수정하세요.';
      byId('hBadge').textContent=c.headerBadge||'좌클릭하여 설명을 수정하세요.';
      byId('intro').innerText=c.intro||'';
      renderTabs(); renderGallery(); renderSchedule();
    }

    // ===== iOS 전용: 터치 DnD 구현 (감도 느리게: 거리 + 롱프레스) =====
    const touchDragConfig = { thresholdPx: 28, longPressMs: 220 }; // 필요시 여기서 조절
    let touchDragging = null; // {payload, startX, startY, moved, ghost, pressReady, pressTimer}
    function enableTouchSource(el, payload){
      el.addEventListener('touchstart', (e)=>{
        if(!isIOS) return;
        if(e.touches.length!==1) return;
        const t=e.touches[0];
        // 롱프레스 타이머가 지나야 드래그 전환 가능
        const pressTimer = setTimeout(()=>{
          if(touchDragging) touchDragging.pressReady = true;
        }, touchDragConfig.longPressMs);
        touchDragging = { payload, startX:t.clientX, startY:t.clientY, moved:false, ghost:null, pressReady:false, pressTimer };
      }, {passive:true});

      el.addEventListener('touchmove', (e)=>{
        if(!isIOS || !touchDragging) return;
        const t=e.touches[0];
        const dx = t.clientX - touchDragging.startX;
        const dy = t.clientY - touchDragging.startY;
        const dist = Math.hypot(dx,dy);

        // 롱프레스가 준비되고, 일정 거리 이상 이동해야 드래그 시작
        if(!touchDragging.moved && touchDragging.pressReady && dist > touchDragConfig.thresholdPx){
          touchDragging.moved = true;
          document.body.classList.add('dragging');
          showGhost(payload, t.clientX, t.clientY);
        }

        if(touchDragging.moved){
          e.preventDefault(); // 드래그 중에만 스크롤/메뉴 차단
          moveGhost(t.clientX, t.clientY);
          const targetIndex = computeDropIndex(t.clientX, t.clientY);
          const cont = byId('schedule');
          if(targetIndex === -1){
            removePlaceholder();
          } else {
            const nodes = Array.from(cont.children).filter(x=> x.classList.contains('card'));
            const ref = nodes[targetIndex];
            if(ref){ cont.insertBefore(placeholder, ref); } else { cont.appendChild(placeholder); }
          }
        }
      }, {passive:false});

      el.addEventListener('touchend', ()=>{
        if(!isIOS || !touchDragging){ return; }
        clearTimeout(touchDragging.pressTimer);
        const wasMoved = touchDragging.moved;
        hideGhost(); document.body.classList.remove('dragging');
        const payload = touchDragging.payload;
        touchDragging = null;
        if(!wasMoved){ return; } // 그냥 스크롤/탭이면 종료
        const insertAt = placeholderIndex();
        removePlaceholder();
        if(insertAt === -1) return;
        applyDrop(payload, insertAt);
      }, {passive:true});

      el.addEventListener('touchcancel', ()=>{
        if(!isIOS || !touchDragging) return;
        clearTimeout(touchDragging.pressTimer);
        hideGhost(); removePlaceholder(); document.body.classList.remove('dragging'); touchDragging=null;
      }, {passive:true});
    }
    function enableTouchDrop(el, onDrop){
      if(!isIOS) return;
      el.addEventListener('touchmove', (e)=>{
        if(!touchDragging) return;
        e.preventDefault();
      }, {passive:false});
      el.addEventListener('touchend', ()=>{
        if(!touchDragging) return;
        clearTimeout(touchDragging.pressTimer);
        const insertAt = placeholderIndex();
        removePlaceholder(); hideGhost(); document.body.classList.remove('dragging');
        const payload = touchDragging.payload; touchDragging = null;
        if(insertAt === -1) return;
        onDrop(insertAt);
      }, {passive:true});
    }
    function showGhost(payload, x, y){
      const g = document.createElement('div'); g.className='drag-ghost';
      g.innerHTML = payload.img ? `<img src="${payload.img}" alt="">` : `<div style="padding:12px 16px;background:#141b26;border:1px solid #344055;border-radius:8px">이동</div>`;
      document.body.appendChild(g);
      touchDragging.ghost = g;
      moveGhost(x,y);
    }
    function moveGhost(x,y){
      const g = touchDragging && touchDragging.ghost; if(!g) return;
      g.style.left = x + 'px'; g.style.top = y + 'px';
    }
    function hideGhost(){
      const g = touchDragging && touchDragging.ghost;
      if(g && g.parentNode){ g.parentNode.removeChild(g); }
      if(touchDragging) touchDragging.ghost=null;
    }
    function computeDropIndex(x, y){
      const cont = byId('schedule');
      const rect = cont.getBoundingClientRect();
      if(y < rect.top || y > rect.bottom || x < rect.left || x > rect.right) return -1;
      const cards = Array.from(cont.querySelectorAll('.card'));
      if(cards.length===0) return 0;
      for(let i=0;i<cards.length;i++){
        const r = cards[i].getBoundingClientRect();
        const midY = r.top + r.height/2;
        const midX = r.left + r.width/2;
        if(Math.abs(y-midY) < r.height*0.25){
          if(x < midX) return i;
          else return i+1;
        }
        if(y < midY) return i;
      }
      return cards.length;
    }

    // ===== Ably 자동 동기화 (room=trip) =====
    const ABLY_KEY = "84KmnQ.XBJyCA:dtalnghkh9M4BwB3rC-gXBDikOu0djb52zWgb0tBuk4"; // 본인 키로 교체
    let rts = { client:null, channel:null, selfId: Math.random().toString(36).slice(2,10), room:"trip", sync:false };
    let writeTimerRT=null;
    let lastRev = 0;
    function pushStateDebounced(){
      if(!rts.sync || !rts.channel) return;
      clearTimeout(writeTimerRT);
      writeTimerRT=setTimeout(()=>{
        const payload={ state: cur(), rev: Date.now(), from: rts.selfId };
        rts.channel.publish("state", payload);
      }, 300);
    }
    function mergeIncomingState(incoming, rev){
      if(rev && lastRev && rev <= lastRev) return;
      lastRev = rev || Date.now();
      const idx = app.items.findIndex(p=>p.id===incoming.id);
      if(idx >= 0){ app.items[idx] = incoming; app.activeId = incoming.id; }
      else { app.items.push(incoming); app.activeId = incoming.id; }
      saveApp(); applyState();
    }
    async function startSync(roomId){
      try{
        if(!ABLY_KEY){ console.warn("Ably 키가 없습니다."); return; }
        if(!rts.client){ rts.client = new Ably.Realtime({ key: ABLY_KEY }); }
        rts.room = roomId || "trip";
        rts.channel = rts.client.channels.get("trip:"+rts.room+"?rewind=1");
        rts.sync = true;
        rts.channel.subscribe("state", (msg)=>{
          const data=msg.data; if(!data) return;
          if(data.from===rts.selfId) return;
          mergeIncomingState(data.state, data.rev);
        });
        rts.channel.subscribe("hello", ()=>{
          const payload={ state: cur(), rev: Date.now(), from: rts.selfId };
          rts.channel.publish("state", payload);
        });
        rts.channel.publish("hello", { from: rts.selfId });
        pushStateDebounced();
      }catch(e){ console.error(e); }
    }

    // ===== Init =====
    function init(){
      loadApp();
      bindHeaderEdit();
      bindIntro();
      bindButtons();
      bindMobileTabbar();
      applyState();
      startSync("trip");
      window.addEventListener('resize', ()=> requestAnimationFrame(updateFlowArrows));
    }
    init();
  </script>
</body>
</html>
